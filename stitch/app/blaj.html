<!doctype html>

<html>
<head>

<meta charset="utf-8" />
  <title>STITCH APP</title>
  <style>
    #drop_zone {
      border: 2px dashed #bbb;
      -moz-border-radius: 5px;
      -webkit-border-radius: 5px;
      border-radius: 5px;
      padding: 25px;
      text-align: center;
      font: 20pt bold 'Vollkorn';
      color: #bbb;
    }

  #selectedFiles img {
    max-width: 250px;
    max-height: 250px;
    float: left;
    margin-bottom:10px;
    margin-left:10px;
  }

    </style>

</head>
    
<body>

  <script type="text/javascript" src="../ext_js/jsfeat-min.js"></script>
  <script type="text/javascript" src="../ext_js/numeric-1.2.6.min.js"></script>
  <script type="text/javascript" src="../ext_js/underscore-min.js"></script>
  <script type="text/javascript" src="../ext_js/hog.js"></script>
  <script type="text/javascript" src="../ext_js/norms.js"></script>
  <script type="text/javascript" src="../ext_js/processing.js"></script>
  <script type="text/javascript" src="../ext_js/jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="../ext_js/d3.min.js"></script>
  <script type="text/javascript" src="../js/find_homographies.js"></script>
  <script type="text/javascript" src="../js/ransac.js"></script>
  <script type="text/javascript" src="../js/imagewarp.js"></script>

  <div id="drop_zone">Drop files here</div>
  <div id="selectedFiles"></div>
  <div id="the_canvas"></div>
  <div id="the_stitch_button"></div>
  <output id="list"></output>

  <script>
  "use strict";


  var imgSrcs =[];
  var selDiv = "";
  var homographies = [];

  document.addEventListener("DOMContentLoaded", init, false);
  
  // Setup the dnd listeners.
  function init() {
      var dropZone = document.getElementById('drop_zone');
      dropZone.addEventListener('dragover', handleDragOver, false);
      dropZone.addEventListener('drop', handleFileSelect, false);
      selDiv = document.querySelector("#selectedFiles");
  }


  function handleFileSelect(e) {
    e.stopPropagation();
    e.preventDefault();

    var files = e.dataTransfer.files; 
    var filesArr = Array.prototype.slice.call(files);

    console.log("fore");    
    filesArr.forEach(function(f) 
    {
        if(!f.type.match("image.*")) {
          return;
        }

        var reader = new FileReader();
        reader.onload = function (e) {

        var html = "<img src=\"" + e.target.result + "\">"  ;//+ f.name
        //Här är src, pucha denna i en array
        selDiv.innerHTML += html;
        console.log("URL:" ,f.name);
        imgSrcs.push(e.target.result);

        }
        reader.readAsDataURL(f);
        
    });

    createButton("the_stitch_button");

  }


  function createButton(id)
  {
    
    var button = document.createElement("input");
    button.type = "button";
    button.value = "Stitch these images";
    button.onclick = start_stitch;

   //the_stitch_button
   //////////////////////////////////////////////
    var div = document.getElementById(id); 
    div.appendChild(button);
    // button.id = "button";
    // var body = document.getElementsByTagName("body")[0];
    // body.appendChild(button);
  }


  function handleDragOver(evt) {
      evt.stopPropagation();
      evt.preventDefault();
      evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
  }


  function start_stitch()
  { 
    //console.log("imgs", imgNames);
    start_stitching()

      function start_stitching()
      {
          var promise = longfunctionfirst().then(shortfunctionsecond);
      }

      function longfunctionfirst()
      {
           var d = new $.Deferred();
           homographies = new find_homographies(imgSrcs, d);

          //d.resolve();
          return d.promise()
      }

      function shortfunctionsecond()
      {
          var d = new $.Deferred();
          warp_App("the_canvas", homographies.H, imgSrcs);
          
          d.resolve();
          return d.promise()
      }
  } 


  </script>

</body>
</html>
