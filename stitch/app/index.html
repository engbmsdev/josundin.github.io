<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Delaunay Triangulation applied on WebCam stream">
        <meta name="author" content="David Corvoysier">
        <title>Delaunay Triangulation applied on WebCam stream".</title>

    </head>
   <body>
   
    <navbar>
        
        <p> <strong>DELAUNAY TRIANGULATION APP</strong> | <input type="file" id="imageLoader" name="imageLoader" /></p>
        
    </navbar>
    <hr/>

        <canvas id="canvas" width="640" height="480"></canvas>

        <script type="text/javascript" src="../ext_js/jsfeat-min.js"></script>
        <script type="text/javascript" src="../ext_js/dat.gui.min.js"></script>
        <script type="text/javascript">


window.addEventListener("load",function() {
    var canvas = document.getElementById('canvas');
    
    var gui,options,ctx;
    var img_u8, corners, threshold, boarder;

    var demo_opt = function(){
        this.threshold = 5;
        this.resolution = 1;//0.5;
        this.draw_borders = false;
    }

var imageLoader = document.getElementById('imageLoader');
            imageLoader.addEventListener('change', handleImage, false);         
            function handleImage(e){
                var reader = new FileReader();
                reader.onload = function(event){
                    var img = new Image();
                    img.onload = function() {
                        
                        try{
                            setTimeout(function() {
                                demo_app();
                            
                                tick();
                            }, 500);
                            
                        }
                        catch (error){
                            log.innerHTML = '<p>Unable to get access to your WebCam.</p>';
                        }
                        
                        function demo_app() {
                            canvasWidth  = canvas.width;
                            canvasHeight = canvas.height;
                            ctx = canvas.getContext('2d');

                            ctx.fillStyle = "rgb(0,255,0)";
                            ctx.strokeStyle = "rgb(0,255,0)";

                            img_u8 = new jsfeat.matrix_t(640, 480, jsfeat.U8_t | jsfeat.C1_t);

                            corners = [];
                            var i = 640*480;
                            while(--i >= 0) {
                                corners[i] = new jsfeat.point2d_t(0,0,0,0);
                            }

                            threshold = 5;

                            jsfeat.fast_corners.set_threshold(threshold);

                            options = new demo_opt();
                            gui = new dat.GUI();

                        var resctl = gui.add(options, 'threshold', 5, 20).step(1);
                        resctl.onFinishChange(function(value){
                            jsfeat.fast_corners.set_threshold(value);
                            tick();
                        });



                        }

                        
                        
                        function tick() {                      
                    
                            var cwidth = Math.floor(640*options.resolution);
                            var cheight = Math.floor(480*options.resolution);
                            
                            ctx.drawImage(img, 0, 0, cwidth, cheight);
                            var imageData = ctx.getImageData(0, 0, cwidth, cheight);
                            
                            jsfeat.imgproc.grayscale(imageData.data, img_u8.data);
                            
                            
                            var count = jsfeat.fast_corners.detect(img_u8, corners, 3);

                            console.log( "number of points", count);
                            console.log("x 0 : ", corners[0].x);
                            console.log("y 0: ", corners[0].y);



                                                // render result back to canvas
                            var data_u32 = new Uint32Array(imageData.data.buffer);
                            render_corners(corners, count, data_u32, 640);
                
                            ctx.putImageData(imageData, 0, 0);

                        }

                        function render_corners(corners, count, img, step) {
                            var pix = (0xff << 24) | (0x00 << 16) | (0xff << 8) | 0x00;
                            for(var i=0; i < count; ++i)
                            {
                                var x = corners[i].x;
                                var y = corners[i].y;
                                var off = (x + y * step);
                                img[off] = pix;
                                img[off-1] = pix;
                                img[off+1] = pix;
                                img[off-step] = pix;
                                img[off+step] = pix;
                            }
                        }
                        
                        

                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(e.target.files[0]);
                
            }

            
        },false);
    </script>
    </body>
</html>
