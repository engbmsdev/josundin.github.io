<!doctype html>

<html>
<head>

<meta charset="utf-8" />
  <title>STITCH APP</title>
  <style>
    #drop_zone {
      border: 2px dashed #bbb;
      -moz-border-radius: 5px;
      -webkit-border-radius: 5px;
      border-radius: 5px;
      padding: 25px;
      text-align: center;
      font: 20pt bold 'Vollkorn';
      color: #bbb;
    }

  #selectedFiles img {
    max-width: 250px;
    max-height: 250px;
    float: left;
    margin-bottom:10px;
    margin-left:10px;
  }

    </style>

</head>
    
<body>

  <script type="text/javascript" src="../ext_js/jsfeat-min.js"></script>
  <script type="text/javascript" src="../ext_js/numeric-1.2.6.min.js"></script>
  <script type="text/javascript" src="../ext_js/underscore-min.js"></script>
  <script type="text/javascript" src="../ext_js/hog.js"></script>
  <script type="text/javascript" src="../ext_js/norms.js"></script>
  <script type="text/javascript" src="../ext_js/processing.js"></script>
  <script type="text/javascript" src="../ext_js/jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="../ext_js/d3.min.js"></script>

  <script type="text/javascript" src="../js/layout.js"></script>
  <script type="text/javascript" src="../js/find_homographies.js"></script>
  <script type="text/javascript" src="../js/ransac.js"></script>
  <script type="text/javascript" src="../js/imagewarp.js"></script>

  <div id="drop_zone">Drop files here</div>
  <div id="selectedFiles"></div>
  <div id="the_canvas"></div>
  <div id="the_stitch_button"></div>
  <output id="list"></output>

  <script>
  "use strict";

  var imageWt = 0, imageHt = 0; 

  var imgSrcs =[];
  var selDiv = "";
  var homographies = [];

  var imgOpt = function(imgsrc){
    this.warpData = 0;
    this.img = new Image();
    this.img.src = imgsrc;
  }

  document.addEventListener("DOMContentLoaded", init, false);
  
  // Setup the dnd listeners.
  function init() {
    var dropZone = document.getElementById('drop_zone');
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileSelect, false);
    selDiv = document.querySelector("#selectedFiles");

    // var scale;
    var canvas;
    var ctx;
    var baseImage = new imgOpt("../imgs/P112.jpg");

    baseImage.img.onload = function() {

      var scale = findScale(baseImage.img.width, baseImage.img.height);
      console.log("scale", scale);

      imageWt = baseImage.img.width * scale;  //640;//892;
      imageHt = baseImage.img.height * scale;  //480;//642;

      canvas = createcanvas();
      ctx = canvas.getContext('2d');  

      ctx.drawImage( baseImage.img, 0 , 0, imageWt, imageHt);


      //   //setupWarp();                    
      //   applyWarp(id, imagesList);

      // //eventuellt radera canvasen n채r klar... fast inte h채r

    }
    
  }


  // function findScale(xSize,ySize,xGoal,yGoal){
  //   // We'll either to match `xSize` to `xGoal` or `ySize` to `yGoal` so
  //   // compute a scale for each.
  //   var xScale = xGoal / xSize;
  //   var yScale = yGoal / ySize;

  //   console.log("scales:", xScale, yScale);

  //   if(yScale < 1 || xScale < 1)
  //   {
  //       // If xScale makes it too tall we'll have to use yScale
  //     // and if yScale makes it too wide we'll have to use xScale
  //     if( xScale * ySize > yGoal ){
  //         return yScale;
  //     }else{
  //         return xScale;
  //     }
  //   }
  //   else
  //     return 1;
  // }


  function createcanvas( ){      
    var tmpCanvas = document.createElement('canvas');
    tmpCanvas.width = imageWt;
    tmpCanvas.height = imageHt;

    tmpCanvas.style=("position: absolute; top: 0px; left: 0px;", "border:1px solid #000000;");
    //canvas.style=(" width:640px;height:480px;margin: 10px auto;");

    //add the canvas
    var body = document.getElementsByTagName("body")[0];
    body.appendChild(tmpCanvas);
    tmpCanvas.id="APPping";
    body.id="body";

    return tmpCanvas;
  };


/////////////////////////////////////////////////////////


  function handleFileSelect(e) {
    e.stopPropagation();
    e.preventDefault();

    var files = e.dataTransfer.files; 
    var filesArr = Array.prototype.slice.call(files);

    console.log("fore");    
    filesArr.forEach(function(f){
        if(!f.type.match("image.*")) {
          return;
        }

        var reader = new FileReader();
        reader.onload = function (e) {

          var html = "<img src=\"" + e.target.result + "\">"  ;//+ f.name
        //H채r 채r src, pucha denna i en array
        selDiv.innerHTML += html;
        console.log("URL:" ,f.name);
        imgSrcs.push(e.target.result);

        }
        reader.readAsDataURL(f);
        
    });

    createButton("the_stitch_button");

  }


  function createButton(id){
    
    var button = document.createElement("input");
    button.type = "button";
    button.value = "Stitch these images";
    button.onclick = start_stitch;

   //the_stitch_button
   //////////////////////////////////////////////
    var div = document.getElementById(id); 
    div.appendChild(button);
    // button.id = "button";
    // var body = document.getElementsByTagName("body")[0];
    // body.appendChild(button);
  }


  function handleDragOver(evt) {
      evt.stopPropagation();
      evt.preventDefault();
      evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
  }


  function start_stitch()
  { 
    //console.log("imgs", imgNames);
    start_stitching()

      function start_stitching(){
          var promise = longfunctionfirst().then(shortfunctionsecond);
      }

      function longfunctionfirst(){

           var d = new $.Deferred();
           homographies = new find_homographies(imgSrcs, d);

          //d.resolve();
          return d.promise();
      }

      function shortfunctionsecond(){

          var d = new $.Deferred();
          warp_App("the_canvas", homographies.H, imgSrcs);
          
          d.resolve();
          return d.promise();
      }
  } 


  </script>

</body>
</html>
