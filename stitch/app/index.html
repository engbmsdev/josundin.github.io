<!doctype html>

<html>
<head>

<meta charset="utf-8" />
  <title>STITCH APP</title>
  <style>
    #drop_zone {
      border: 2px dashed #bbb;
      -moz-border-radius: 5px;
      -webkit-border-radius: 5px;
      border-radius: 5px;
      padding: 25px;
      text-align: center;
      font: 20pt bold 'Vollkorn';
      color: #bbb;
    }

  #selectedFiles img {
    max-width: 250px;
    max-height: 250px;
    float: left;
    margin-bottom:10px;
    margin-left:10px;
  }

  </style>

  <script type="text/javascript" src="../ext_js/jsfeat-min.js"></script>
  <script type="text/javascript" src="../ext_js/numeric-1.2.6.min.js"></script>
  <script type="text/javascript" src="../ext_js/underscore-min.js"></script>
  <script type="text/javascript" src="../ext_js/hog.js"></script>
  <script type="text/javascript" src="../ext_js/norms.js"></script>
  <script type="text/javascript" src="../ext_js/processing.js"></script>
  <script type="text/javascript" src="../ext_js/jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="../ext_js/d3.min.js"></script>

  <script type="text/javascript" src="../js/layout.js"></script>
  <script type="text/javascript" src="../js/find_homographies.js"></script>
  <script type="text/javascript" src="../js/ransac.js"></script>
  <script type="text/javascript" src="../js/imagewarp.js"></script>
  <link rel="stylesheet" href="../libs/twitter-bootstrap/bootstrap.min.css">


  <div class="container">

    <header>
      <h1>Image Stitching - Web-tool</h1>
      <p>With some supplementary information, fungerar bast i vissa broesers</p>
    </header>

    <div class="row">
      <div class="span12">
        <p>
          Stitch two or more images by File Browse: <input type="file" id="files" name="files" multiple accept="image/*"><br/>
        </p>
        <p>
          or       
        </p>
      </div>

      <!--button type="button" class="btn btn-primary">Primary Button to to do Stuff</button-->

    </div>
  
  <div id="drop_zone">Drop images here</div>

    <div class="row">
      <div class="span12">
        <div id="pre-stitch" style="display:none;">
          <h2>1 What is this?</h2>
          <p>
            1.1 Resemble.js analyses and compares images with HTML5 canvas and JavaScript.
          </p>
          <p>
            <strong>Try it for yourself.</strong>
          </p>
        </div>
        <div id="selectedFiles" class="selectedFiles"></div>
      </div>
    </div>
    <div class="row">
      <div class="span12">
        <div id="pre-stitch2" style="display:none;">
          <p>
            <strong>You have selected the above images. Run the algorithm to <button type="button" class="btn btn-primary" id="example-images">stitch the images</button>
            </strong> Or Select new ones. 
          </p>
        </div>
      </div> 
    </div>

    <div class="row">

      <div class="span12">
        <div id="stitched" style="display:none;">
          <h2>Result:</h2>

          <div id="the_canvas"></div>
        </div>
      </div>
    </div>

  </div>
</head>
    
<body>

  <script>
  "use strict";

  var imageWt = 0, imageHt = 0; 

  var imgSrcs =[];
  var selDiv = "";
  var homographies = [];

  var imgOpt = function(imgsrc){
    this.warpData = 0;
    this.img = new Image();
    this.img.src = imgsrc;
  }

  document.addEventListener("DOMContentLoaded", init, false);
  
  // Setup the dnd listeners.
  function init() {
    var dropZone = document.getElementById('drop_zone');
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileSelect, false);
    document.querySelector('#files').addEventListener('change', handleFileSelectButton, false);

    selDiv = document.querySelector("#selectedFiles"); 
    
  }

  function createcanvas( ){      
    var tmpCanvas = document.createElement('canvas');
    tmpCanvas.width = imageWt;
    tmpCanvas.height = imageHt;

    //tmpCanvas.style=("position: absolute; top: 0px; left: 0px;", "border:1px solid #000000;");
    //canvas.style=(" width:640px;height:480px;margin: 10px auto;");

    //add the canvas
    var body = document.getElementsByTagName("body")[0];
    body.appendChild(tmpCanvas);
    tmpCanvas.id="APPping";
    body.id="body";

    return tmpCanvas;
  };


/////////////////////////////////////////////////////////

  function handleFileSelectButton(e) {
    
    if(!e.target.files || !window.FileReader) return;
    
    selDiv.innerHTML = "";
    imgSrcs =[];
    homographies = [];
    
    var files = e.target.files;
    console.log("the files:", files);
    var filesArr = Array.prototype.slice.call(files);

    console.log("fore");    
    filesArr.forEach(function(f) 
    {
      if(!f.type.match("image.*")) {
        return;
      }

      var reader = new FileReader();
      reader.onload = function (e) {

      var html = "<img src=\"" + e.target.result + "\">"  ;//+ f.name
      //H채r 채r src, pucha denna i en array
      selDiv.innerHTML += html;
      console.log("URL:" ,f.name);
      imgSrcs.push(e.target.result);

      }
      reader.readAsDataURL(f);
      
    });
    
    showStuff();

  }


  function handleFileSelect(e) {

    selDiv.innerHTML = "";
    imgSrcs =[];
    homographies = [];

    e.stopPropagation();
    e.preventDefault();

    var files = e.dataTransfer.files; 
    var filesArr = Array.prototype.slice.call(files);

    console.log("fore");    
    filesArr.forEach(function(f){
        if(!f.type.match("image.*")) {
          return;
        }

        var reader = new FileReader();
        reader.onload = function (e) {

          var html = "<img src=\"" + e.target.result + "\">"  ;//+ f.name
        //H채r 채r src, pucha denna i en array
        selDiv.innerHTML += html;
        console.log("URL:" ,f.name);
        imgSrcs.push(e.target.result);

        }
        reader.readAsDataURL(f);
        
    });

    showStuff();

  }



  function showStuff(){
    $('#pre-stitch').show();
    $('#pre-stitch2').show();
    //createButton("the_stitch_button");
  }


  $('#example-images').click(function(){
    start_stitch();
    return false;
  });


  function handleDragOver(evt) {
      evt.stopPropagation();
      evt.preventDefault();
      evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
  }


  function start_stitch()
  { 
    //console.log("imgs", imgNames);
    start_stitching()

      function start_stitching(){
          var promise = longfunctionfirst().then(shortfunctionsecond);
      }

      function longfunctionfirst(){

           var d = new $.Deferred();
           homographies = new find_homographies(imgSrcs, d);

          //d.resolve();
          return d.promise();
      }

  function shortfunctionsecond(){

    var d = new $.Deferred();
    $('#stitched').show();

    if(homographies.H == -1){
      console.log("no Goood");

      var para = document.createElement("h2");
      var node = document.createTextNode("Could not fit a Homography");
      para.appendChild(node);

      var element = document.getElementById("the_canvas");
      element.appendChild(para);

    }

    else{
    warp_App("the_canvas", homographies.H, imgSrcs);

    }

    d.resolve();
    return d.promise();
  }
  } 


  </script>

</body>
</html>
