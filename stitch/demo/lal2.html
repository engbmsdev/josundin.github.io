<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>The Demo</title>
<style>
	.selectedFiles img {
		max-width: 250;
		max-height: 250px;
		float: left;
		margin-bottom:10px;
		margin-left:10px;
	}

	table, th, td {
	    border: 1px solid black;
	    border-collapse: collapse;
	}
	th, td {
	    padding: 5px;
	}
	th {
	    text-align: left;
	}

</style>

	
	
	<!--script type="text/javascript" src="../ext_js/underscore-min.js"></script>
	<script type="text/javascript" src="../ext_js/hog.js"></script>
	
	
	<script type="text/javascript" src="../ext_js/jquery-1.9.1.min.js"></script>

  	<script type="text/javascript" src="../js/layout.js"></script>
	<script type="text/javascript" src="../js/find_homographies.js"></script>
	<script type="text/javascript" src="../js/ransac.js"></script>
	<script type="text/javascript" src="../js/imagewarp.js"></script-->
	<script type="text/javascript" src="../ext_js/jsfeat-min.js"></script>
	<script type="text/javascript" src="../ext_js/processing.js"></script>
	<script type="text/javascript" src="../ext_js/profiler.js"></script>
	<script type="text/javascript" src="../ext_js/numeric-1.2.6.min.js"></script>
	<script type="text/javascript" src="../ext_js/norms.js"></script>

	<script type="text/javascript" src="../js/imgfeatures.js"></script>
	<script type="text/javascript" src="../js/bruteForceMatching.js"></script>
	<link rel="stylesheet" href="../libs/twitter-bootstrap/new_bootstrap.min.css">
</head>
<body>
<div class="container">
	<header>
	    <h1>Image Stitching - Demo</h1>
	    <p>To create a panoramic image a photographer can start by taking multiple photos of a scene. This can be done by putting the camera in continuous shoot mode or a similar setting on the specific device. A burst or a sequence of multiple images is a premises to this application.</p>
	</header>

	<div class="row">

		<div class="span12">
			<h2>3 Stitch</h2>
			<p>
				Stitch the two example images together to one and the same image.
				Number of interest points: 
			</p>
 
				<div class="col-md-4">
					<!--div id="log_pts" ></div-->
					<div id="table1"class="alert alert-info" ></div>

				</div>
				<div class="col-md-4">
					<div id="log" class="alert alert-info"></div>
				</div>
				<div class="col-md-4">
					Matching time
					<div id="matchingTime" class="alert alert-info"></div>
				</div>
			
		</div>
	</div>

	<div class="row">

		<div class="span12">
			<h2>2 Stitch</h2>
			<p>
				Stitch the two example images together to one and the same image
			</p>

			<div id="divStitched"></div>
		
		</div>
	</div>

</div>


<script type="text/javascript">
"use strict";

	document.addEventListener("DOMContentLoaded", init, false);

	function pipe_opt(){
	    this.descriptor_radius = 8;
	    this.corner_threshold = 45;
	    this.lowe_criterion = 0.8;
	   	this.ransac_iter = 1500;
	    this.ransac_inlier_threshold = 3 * 0.01;
	}
	var myDescriptors = [];
	var my_opt = new pipe_opt();
	var stat = new profiler();
	var timeProcces = new profiler();
	var statMatch = new profiler();
	var table1 = document.getElementById('table1');
	table1.style= "width:100%";

	function init() {

		var log = document.getElementById('log');
		var matchingTime = document.getElementById('matchingTime');
		var canvas = loadCanvas("divStitched");
		//var images = ["../imgs/P112.jpg", "../imgs/P110.jpg", "../imgs/P111.jpg"];
		var images = ["../imgs/left.jpg", "../imgs/right.jpg"];
		//var images = ["../imgs/P112.jpg"];

		timeProcces.add("T1");

		stat.add("load image into browser");
		stat.add("fast corners");
		stat.add("gradientVectors");
		stat.add("descriptors");
		statMatch.add("matching");

		var indx = 0;
		updateTable('Image name: ', 'Number of pts: ', 'Process time: ');


		computeFeatures(images[indx++]);

		function computeFeatures(img){
			timeProcces.start("T1");

		 	var test_img = myPowerConstructor(img, stat);	
		 	test_img.set(canvas, my_opt, whenDataReady);

			function whenDataReady() {
				//

				//
				timeProcces.stop("T1");
				var pts = test_img.getNuberOfPoints();
				var srcImg = test_img.getSrc();
				var lastIndex = srcImg.lastIndexOf("/");

				myDescriptors.push(test_img.getDescriptor());

				srcImg = srcImg.substring(srcImg.length, lastIndex +1);
				console.log("img done, nr pts", pts, "in:", srcImg);
				//Img name | number of points | time to process
				//log_pts.innerHTML += "Img name: " + srcImg + " Nr of pts: " +  pts + " in: " + "Process time: " + timeProcces.log(1) + " ms" + "<br>";	
				updateTable(srcImg, pts, timeProcces.log(1));

			    ///////////////////////////////////////
				log.innerHTML = stat.log();

				if(indx < (images.length)){
					computeFeatures(images[indx++]);
				}
				else{
					console.log("done computeFeatures");
					doneComputeFeatures();
				}

			};

		};

		function updateTable(txt1, txt2, text3) {

			var tr = document.createElement('tr');
		    var text1 = document.createTextNode(txt1);
			var text2 = document.createTextNode(txt2);
			var text3 = document.createTextNode(text3);
			var td1 = document.createElement('td');
			var td2 = document.createElement('td');
			var td3 = document.createElement('td');
		    td1.appendChild(text1);
		    td2.appendChild(text2);
		    td3.appendChild(text3);
		    tr.appendChild(td1);
		    tr.appendChild(td2);
		    tr.appendChild(td3);
		    table1.appendChild(tr);
		};

	};

////////////////////////////////////////////////////////////////


function doneComputeFeatures(){
	statMatch.start("matching");
	console.log("done computeFeatures !!!!!!!!!!!!!!");
	var baseImageDesc = myDescriptors[0];
	var restImageDesc = [];

    for (var i=0; i<myDescriptors.length - 1; i++)
    {
        restImageDesc.push(myDescriptors[i + 1]);
    }

    var matching = new bruteForceMatching(my_opt.lowe_criterion);

    matching.set(baseImageDesc, restImageDesc[0], whenMatchinDone);

    function whenMatchinDone(argument) {

    	console.log("The matches", argument);
    	statMatch.stop("matching");
    	matchingTime.innerHTML = statMatch.log();

	  	//RASAC to find a good model
      	var homography = ransac(argument, my_opt.ransac_inlier_threshold, my_opt.ransac_iter);
      	homographies.push(homography);
    }
 
};


function loadCanvas(id){

    var canvas = document.createElement('canvas');
    var div = document.getElementById(id); 
    canvas.id     = "calculateDecriptors";
    // canvas.width  = 500;
    // canvas.height = 400;
    // canvas.style.zIndex   = 8;
    // canvas.style.position = "absolute";
    // canvas.style.border   = "1px solid";
    div.appendChild(canvas);

    return canvas;
}

</script>
</body>
</html>