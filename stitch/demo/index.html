<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<title>The Demo</title>
<style>
	.selectedFiles img {
		max-width: 250;
		max-height: 250px;
		float: left;
		margin-bottom:10px;
		margin-left:10px;
	}
</style>

	<script type="text/javascript" src="../ext_js/jsfeat-min.js"></script>
	<script type="text/javascript" src="../ext_js/numeric-1.2.6.min.js"></script>
	<script type="text/javascript" src="../ext_js/underscore-min.js"></script>
	<script type="text/javascript" src="../ext_js/hog.js"></script>
	<script type="text/javascript" src="../ext_js/norms.js"></script>
	<script type="text/javascript" src="../ext_js/processing.js"></script>
	<script type="text/javascript" src="../ext_js/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="../ext_js/d3.min.js"></script>

  	<script type="text/javascript" src="../js/layout.js"></script>
	<script type="text/javascript" src="../js/find_homographies.js"></script>
	<script type="text/javascript" src="../js/ransac.js"></script>
	<script type="text/javascript" src="../js/imagewarp.js"></script>
	<link rel="stylesheet" href="../libs/twitter-bootstrap/bootstrap.min.css">
</head>
<body>
<div class="container">
	<header>
	    <h1>Image Stitching - Demo</h1>
	    <p>To create a panoramic image a photographer can start by taking multiple photos of a scene. This can be done by putting the camera in continuous shoot mode or a similar setting on the specific device. A burst or a sequence of multiple images is a premises to this application.</p>
	</header>


	<div class="row">

		<div class="span12">
			<h2>1 The images</h2>
			<p>
				Step one is to get two or more images from the same one scene. Make sure that each photo has about 10-30% overlap with all other adjacent photos.
			</p>
			
			<div id="selectedF1" class="selectedFiles"></div>

		</div>
	</div>


	<div class="row">

		<div class="span12">
			<h2>2 Stitch</h2>
			<p>
				Stitch the two example images together to one and the same image
			</p>

			<div id="divStitched"></div>
		
		</div>
	</div>


	<div class="row">

		<div class="span12">
			<h2>Multiple images</h2>
			<p>
				The following three images, each one have higher resolution then the first each two.
			</p>

			<div id="selectedF2" class="selectedFiles"></div>


			<div class="span6">
				<h2>Stitch Multiple images</h2>
				<p>
					This panorama will take a bit longer to compute since the images are bigger and they are more.
				</p>
				<p>
				<button type="button" class="btn btn-primary" id="example-images">Stitch the images</button>
				</p>
			</div>


			<!--button type="button" class="btn btn-primary">Primary Button to to do Stuff</button-->

		</div>
	</div>


	<div class="row">

		<div class="span12">
			<h2> Result </h2>
			<p>
				You can see that the size of the stitched common image increase with the number of images. The common stitched size is calculated with help of the corners of the transformed images.
			</p>

			<div id="divStitched2"></div>

			<p>
				<strong>Try it for yourself.</strong>
			</p>
		
		</div>
	</div>

</div>


<script type="text/javascript">
"use strict";

	var imgOpt = function(imgsrc){
	    this.warpData = 0;
	    this.img = new Image();
	    this.img.src = imgsrc;
		}



	var baseImage;
	var images1 = ["../imgs/left.jpg", "../imgs/right.jpg"];
	var images2 = ["../imgs/P112.jpg", "../imgs/P110.jpg", "../imgs/P111.jpg"];
	//var images1 = ["../imgs/P112.jpg", "../imgs/P110.jpg", "../imgs/P111.jpg"];
	//var images1 = ["../imgs/IMG_0050.jpg", "../imgs/IMG_0051.jpg", "../imgs/IMG_0053.jpg"];
	var homographies = [];
	document.addEventListener("DOMContentLoaded", init, false);


	function init() {
		
		var selDiv1 = document.querySelector("#selectedF1");
		
		placeimgs(images1, selDiv1);

		// var canvas = loadCanvas("divGameStage");
	 //    var ctx = canvas.getContext('2d');
	 //    ctx.drawImage(baseImage.img, 0, 0);

	 	start_stitch(images1);


		var selDiv2 = document.querySelector("#selectedF2");
		placeimgs(images2, selDiv2);		

	}


	function placeimgs(images, wdiv){

		var filesArr = Array.prototype.slice.call(images);

		for (var i = 0; i < images.length; i++) 
		{
			baseImage = new imgOpt(images[i]);
			
			var image = new Image();
			// Set path and alt properties
			image.src = images[i];
			//image.alt = alt;

			// Add it to the DOM
			wdiv.appendChild(image);

		}

	}


	//To make sure functions are made in sequences, for the alignment
    function start_stitch(stitch_imgs){
        var promise = longfunctionfirst(stitch_imgs).then(shortfunctionsecond);
    }

    function longfunctionfirst(stitch_imgs){
         var d = new $.Deferred();
         homographies = new find_homographies(images1, d);

        //d.resolve();
        return d.promise();
    }

    // function shortfunctionsecond(){
    //     var d = new $.Deferred();
    //     warp_App("divStitched", homographies.H, images1);

    //     d.resolve();
    //     return d.promise();
    // }

	function shortfunctionsecond(){

		var d = new $.Deferred();

		if(homographies.H == -1){
			console.log("no Goood");

			var para = document.createElement("h2");
			var node = document.createTextNode("Could not fit a Homography");
			para.appendChild(node);

			var element = document.getElementById("divStitched");
			element.appendChild(para);

		}

		else{
		warp_App("divStitched", homographies.H, images1);

		}

		d.resolve();
		return d.promise();
	}


    function loadCanvas(id){

        var canvas = document.createElement('canvas');
        var div = document.getElementById(id); 
        canvas.id     = "CursorLayer";
        canvas.width  = 500;
        canvas.height = 400;
        canvas.style.zIndex   = 8;
        canvas.style.position = "absolute";
        canvas.style.border   = "1px solid";
        div.appendChild(canvas);

        return canvas;
    }


	$('#example-images').click(function(){

		console.log("Do the Stuff");
		start_stitch2();

		return false;
	});

	//To make sure functions are made in sequences, for the alignment
    function start_stitch2(){
        var promise = longfunctionfirst2().then(shortfunctionsecond2);
    }

    function longfunctionfirst2(){
         var d = new $.Deferred();
         homographies = new find_homographies(images2, d);

        //d.resolve();
        return d.promise();
    }

    function shortfunctionsecond2(){
        var d = new $.Deferred();
        warp_App("divStitched2", homographies.H, images2);

        d.resolve();
        return d.promise();
    }

</script>
</body>
</html>